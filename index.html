<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рецепты Bubble Street</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { --primary-color: #8a2be2; --light-primary-color: #eadafb; }
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; height: 100%; background-color: #f4f4f9; }
        .app-container { display: flex; height: 100vh; flex-direction: row; }
        .sidebar { width: 300px; background-color: #ffffff; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        .sidebar-header h2 { margin: 0; font-size: 1.2em; pointer-events: none; }
        .sidebar-tabs { display: flex; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #f8f9fa; cursor: pointer; font-size: 1em; }
        .tab-btn.active { background: #fff; border-bottom: 3px solid var(--primary-color); font-weight: bold; }
        .sidebar-content { overflow-y: auto; flex-grow: 1; }
        .sidebar-footer { padding: 10px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }
        .list-container { list-style: none; padding: 0; margin: 0; }
        .list-container a { display: block; padding: 15px 20px; color: #333; text-decoration: none; transition: background-color 0.2s; border-bottom: 1px solid #f0f0f0; }
        .list-container a:hover { background-color: #f0f0f0; }
        .list-container a.active { background-color: var(--light-primary-color); font-weight: bold; color: var(--primary-color); }
        .content { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .content-placeholder { display: flex; justify-content: center; align-items: center; height: 100%; color: #888; font-size: 1.5em; text-align: center; }
        .recipe-view-container { display: flex; gap: 30px; align-items: flex-start; }
        .recipe-details { flex: 1.5; min-width: 0; }
        .recipe-image-container { flex: 1; min-width: 0; position: sticky; top: 25px; }
        .recipe-image-container img { width: 100%; height: auto; border-radius: 12px; object-fit: contain; max-height: 80vh; }
        .recipe-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        h1 { margin: 0; }
        .steps-list { list-style-type: none; padding-left: 0; counter-reset: step-counter; }
        .steps-list > li { counter-increment: step-counter; margin-bottom: 20px; display: flex; align-items: flex-start; }
        .steps-list > li::before { content: counter(step-counter); margin-right: 15px; background-color: var(--primary-color); color: white; width: 35px; height: 35px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .step-wrapper { display: flex; flex-direction: column; width: 100%; }
        .step-description { font-weight: 500; margin-bottom: 12px; font-size: 1.1em; }
        .step-ingredients-table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        .step-ingredients-table th, .step-ingredients-table td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; word-wrap: break-word; }
        .step-ingredients-table th { background-color: #f8f9fa; font-size: 0.9em; }
        .volume-selector { text-align: center; padding: 20px 0; }
        .volume-selector-buttons { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .volume-btn { font-size: 1.5em; padding: 20px 40px; border-radius: 10px; cursor: pointer; border: 2px solid var(--primary-color); background: #fff; color: var(--primary-color); }
        .volume-toggle { display: flex; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .toggle-btn { padding: 10px 20px; background: #f0f0f0; border: none; cursor: pointer; font-size: 1em; flex-grow: 1; }
        .toggle-btn.active { background: var(--primary-color); color: white; }
        .edit-controls button, .btn { padding: 8px 15px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-success { background-color: #198754; color: white; border-color: #198754; }
        .btn-danger { background-color: #dc3545; color: white; border-color: #dc3545; }
        .btn-full-width { width: 100%; padding: 12px; font-size: 1.1em; margin: 0; }
        .edit-form input, .edit-form textarea { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .edit-step { border: 1px dashed #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .edit-ingredient, .edit-step { cursor: grab; }
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
        .edit-ingredient-container { display: flex; flex-direction: column; gap: 5px; }
        .edit-ingredient { display: grid; grid-template-columns: 1fr 80px 80px auto; gap: 10px; align-items: center; }
        .edit-ingredient-single { grid-template-columns: 1fr 120px auto; }
        .edit-ingredient-header { display: grid; grid-template-columns: 1fr 80px 80px auto; gap: 10px; font-weight: bold; font-size: 0.9em; }
        .edit-ingredient-header-single { grid-template-columns: 1fr 120px auto; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 25px; border-radius: 8px; width: 90%; max-width: 700px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .modal-close { font-size: 2em; cursor: pointer; line-height: 1; border: none; background: none; }
        #export-textarea { width: 100%; height: 40vh; font-family: monospace; font-size: 0.9em; resize: vertical; }
        .admin-only { display: none !important; }
        body.admin-mode-active .admin-only { display: flex !important; }
        body.admin-mode-active .sidebar-footer { display: flex !important; }
        
        @media (max-width: 1000px) {
            .recipe-view-container { flex-direction: column; }
            .recipe-image-container { position: static; width: 100%; margin-top: 25px; order: 2; }
            .recipe-details { order: 1; }
            .recipe-image-container img { max-height: none; object-fit: contain; }
        }
        @media (max-width: 768px) {
            .app-container { flex-direction: column; height: auto; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; max-height: 40vh; }
            .content { padding: 15px; }
            .edit-ingredient { grid-template-columns: 1fr 60px 60px auto; gap: 5px; }
            .edit-ingredient-single { grid-template-columns: 1fr 80px auto; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header" id="menu-title-trigger"><h2>Меню</h2></div>
            <div class="sidebar-tabs">
                <button class="tab-btn active" id="tab-drinks">Напитки</button>
                <button class="tab-btn" id="tab-preps">Заготовки</button>
            </div>
            <div class="sidebar-content">
                <ul id="drinks-list" class="list-container"></ul>
                <ul id="preps-list" class="list-container" style="display: none;"></ul>
            </div>
            <div class="sidebar-footer admin-only">
                <button id="new-item-btn" class="btn btn-primary btn-full-width">Создать новый напиток</button>
                <button id="export-btn" class="btn btn-success btn-full-width">Экспорт данных для GitHub</button>
            </div>
        </nav>
        <main class="content">
            <div id="content-output"><div class="content-placeholder"><p>← Выберите элемент из меню</p></div></div>
        </main>
    </div>

    <div class="modal-overlay" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Код для обновления initialData</h3>
                <button class="modal-close" id="export-modal-close">&times;</button>
            </div>
            <p>Скопируйте весь этот текст и вставьте его вместо старого блока `initialData` в файле `index.html` на GitHub.</p>
            <textarea id="export-textarea" readonly></textarea>
            <button id="copy-code-btn" class="btn btn-primary btn-full-width" style="margin-top: 15px;">Скопировать код</button>
        </div>
    </div>
    
    <script>
    // =======================================================================
    // ИСХОДНЫЕ ДАННЫЕ С ФОТОГРАФИЯМИ И НОВЫМИ НАПИТКАМИ
    // =======================================================================
var initialData = {
    "recipes": {
        "classic": {
            "name": "Классический",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/klassichesky.jpg",
            "allIngredients": {
                "milk": {
                    "name": "Молоко 3,2%",
                    "size500": "70",
                    "size650": "90"
                },
                "assam-tea": {
                    "name": "Чай Ассам заготовка",
                    "size500": "50",
                    "size650": "75"
                },
                "cane-syrup": {
                    "name": "Тростниковый сироп",
                    "size500": "20",
                    "size650": "25"
                },
                "cream": {
                    "name": "Сливки 10%",
                    "size500": "70",
                    "size650": "90"
                },
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "size500": "70",
                    "size650": "70"
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "milk",
                        "assam-tea",
                        "cane-syrup",
                        "cream"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam"
                    ]
                }
            ]
        },
        "cold-brew": {
            "name": "КолдБрю",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/kolkbru.jpg",
            "allIngredients": {
                "baked-milk": {
                    "name": "Топленое молоко",
                    "size500": "70",
                    "size650": "90"
                },
                "espresso": {
                    "name": "Кофе (Эспрессо)",
                    "size500": "50",
                    "size650": "75"
                },
                "cane-syrup": {
                    "name": "Тростниковый сироп",
                    "size500": "20",
                    "size650": "25"
                },
                "cream": {
                    "name": "Сливки 10%",
                    "size500": "70",
                    "size650": "90"
                },
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "size500": "70",
                    "size650": "70"
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "baked-milk",
                        "espresso",
                        "cane-syrup",
                        "cream"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam"
                    ]
                }
            ]
        },
        "hot-snickers": {
            "name": "Сникерс (тёплый)",
            "volumeType": "single",
            "imageUrl": "",
            "allIngredients": {
                "assam-tea": {
                    "name": "Заготовка чая Ассам",
                    "quantity": "75"
                },
                "peanut-syrup": {
                    "name": "Сироп Арахис в карамели",
                    "quantity": "40"
                },
                "choco-syrup": {
                    "name": "Сироп Шоколад",
                    "quantity": "20"
                },
                "milk": {
                    "name": "Тёплое молоко (через кофемашину)",
                    "quantity": "270"
                },
                "tapioca": {
                    "name": "Тапиока",
                    "quantity": "80"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "quantity": "70гр"
                },
                "peanuts": {
                    "name": "Арахис жареный",
                    "quantity": "5гр"
                }
            },
            "steps": [
                {
                    "description": "Добавить в питчер:",
                    "ingredientKeys": [
                        "assam-tea",
                        "peanut-syrup",
                        "choco-syrup",
                        "milk"
                    ]
                },
                {
                    "description": "Взбить капучинатором до минимальной пенки (1-я скорость)",
                    "ingredientKeys": []
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "peanuts"
                    ]
                }
            ],
            "volume": "500 мл"
        },
        "hot-bubble-coffee": {
            "name": "Бабл кофе (тёплый)",
            "volumeType": "single",
            "imageUrl": "",
            "allIngredients": {
                "baked-milk": {
                    "name": "Молоко топленое",
                    "quantity": "270"
                },
                "cane-syrup": {
                    "name": "Тростниковый сироп",
                    "quantity": "35"
                },
                "tapioca": {
                    "name": "Тапиока",
                    "quantity": "60"
                },
                "espresso": {
                    "name": "Эспрессо",
                    "quantity": "35"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "quantity": "70"
                },
                "choco-flakes": {
                    "name": "Стружка шоколада",
                    "quantity": ""
                }
            },
            "steps": [
                {
                    "description": "В питчер налить:",
                    "ingredientKeys": [
                        "baked-milk",
                        "cane-syrup"
                    ]
                },
                {
                    "description": "Взбить капучинатором до минимальной пенки (1-я скорость)",
                    "ingredientKeys": []
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca"
                    ]
                },
                {
                    "description": "Перелить содержимое питчера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Аккуратно влить сверху:",
                    "ingredientKeys": [
                        "espresso"
                    ]
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "choco-flakes"
                    ]
                }
            ],
            "volume": "500 мл"
        },
        "hot-almond-mokka": {
            "name": "Миндальный мокко (тёплый)",
            "volumeType": "single",
            "imageUrl": "",
            "allIngredients": {
                "milk": {
                    "name": "Молоко",
                    "quantity": "270"
                },
                "cocoa-base": {
                    "name": "Основа какао",
                    "quantity": "10"
                },
                "almond-syrup": {
                    "name": "Сироп миндальный",
                    "quantity": "25"
                },
                "tapioca": {
                    "name": "Тапиока",
                    "quantity": "60"
                },
                "espresso": {
                    "name": "Эспрессо",
                    "quantity": "35"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "quantity": "70"
                },
                "ing_1762543086847": {
                    "name": "Какао-порошок",
                    "quantity": ""
                }
            },
            "steps": [
                {
                    "description": "Добавить в питчер:",
                    "ingredientKeys": [
                        "milk",
                        "cocoa-base",
                        "almond-syrup"
                    ]
                },
                {
                    "description": "Взбить капучинатором до минимальной пенки (1-я скорость)",
                    "ingredientKeys": []
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca"
                    ]
                },
                {
                    "description": "Перелить содержимое питчера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Аккуратно влить сверху:",
                    "ingredientKeys": [
                        "espresso"
                    ]
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "ing_1762543086847"
                    ]
                }
            ],
            "volume": "500 мл"
        },
        "hot-matcha-mango": {
            "name": "Матча Манго Кокос (тёплый)",
            "volumeType": "single",
            "imageUrl": "",
            "allIngredients": {
                "mango-concentrate": {
                    "name": "Концентрат Манго",
                    "quantity": "20"
                },
                "coconut-syrup": {
                    "name": "Сироп Кокос",
                    "quantity": "30"
                },
                "milk": {
                    "name": "Тёплое молоко (через кофемашину)",
                    "quantity": "270"
                },
                "tapioca": {
                    "name": "Тапиока",
                    "quantity": "60"
                },
                "matcha-prep": {
                    "name": "Матча (заготовка)",
                    "quantity": "35"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "quantity": "70"
                },
                "ing_1762542931470": {
                    "name": "Кокосовая стружка",
                    "quantity": ""
                }
            },
            "steps": [
                {
                    "description": "Добавить в питчер:",
                    "ingredientKeys": [
                        "mango-concentrate",
                        "coconut-syrup",
                        "milk"
                    ]
                },
                {
                    "description": "Взбить капучинатором до минимальной пенки (1-я скорость)",
                    "ingredientKeys": []
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca"
                    ]
                },
                {
                    "description": "Перелить содержимое питчера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Аккуратно влить сверху:",
                    "ingredientKeys": [
                        "matcha-prep"
                    ]
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "ing_1762542931470"
                    ]
                }
            ],
            "volume": "500 мл"
        },
        "sea-buckthorn-tea": {
            "name": "Облепиховый чай",
            "volumeType": "single",
            "imageUrl": "",
            "allIngredients": {
                "base": {
                    "name": "Концентрат Облепиха",
                    "quantity": "50 мл"
                },
                "seabuckthorn": {
                    "name": "Облепиха свежая",
                    "quantity": "10 гр"
                },
                "cinnamon": {
                    "name": "Корица 1шт",
                    "quantity": "1 шт"
                },
                "ginger": {
                    "name": "Имбирь 2 слайса",
                    "quantity": "2 слайса"
                }
            },
            "steps": [
                {
                    "description": "Добавить в стакан:",
                    "ingredientKeys": [
                        "base",
                        "seabuckthorn",
                        "cinnamon",
                        "ginger"
                    ]
                },
                {
                    "description": "Залить кипятком и тщательно перемешать.",
                    "ingredientKeys": []
                }
            ],
            "volume": "450 мл"
        },
        "mulled-wine-tea": {
            "name": "Глинтвейн (б/а)",
            "volumeType": "single",
            "imageUrl": "",
            "allIngredients": {
                "base": {
                    "name": "Концентрат Глинтвейн",
                    "quantity": "45"
                },
                "apple": {
                    "name": "Яблоко",
                    "quantity": "1 долька"
                },
                "orange": {
                    "name": "Апельсин",
                    "quantity": "1 долька"
                },
                "anise": {
                    "name": "Бадьян",
                    "quantity": "1 шт"
                },
                "clove": {
                    "name": "Гвоздика",
                    "quantity": "1 шт"
                },
                "cinnamon": {
                    "name": "Корица",
                    "quantity": "1 шт"
                }
            },
            "steps": [
                {
                    "description": "Добавить в стакан:",
                    "ingredientKeys": [
                        "base",
                        "apple",
                        "orange",
                        "anise",
                        "clove",
                        "cinnamon"
                    ]
                },
                {
                    "description": "Залить кипятком и тщательно перемешать.",
                    "ingredientKeys": []
                }
            ],
            "volume": "450 мл"
        },
        "oreo": {
            "name": "Орео",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/oreo.jpg",
            "allIngredients": {
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "milk": {
                    "name": "Молоко 3,2%",
                    "size500": "140",
                    "size650": "180"
                },
                "assam-tea": {
                    "name": "Чай Ассам заготовка",
                    "size500": "50",
                    "size650": "75"
                },
                "condensed-milk": {
                    "name": "Сгущеное молоко",
                    "size500": "25",
                    "size650": "30"
                },
                "cocoa-prep": {
                    "name": "Какао заготовка",
                    "size500": "25",
                    "size650": "30"
                },
                "cane-syrup": {
                    "name": "Тростниковый сироп",
                    "size500": "5",
                    "size650": "5"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "size500": "70",
                    "size650": "70"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                },
                "oreo-crumbs": {
                    "name": "Крошка печенья Орео",
                    "size500": "",
                    "size650": ""
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "assam-tea",
                        "milk",
                        "condensed-milk",
                        "cocoa-prep"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca",
                        "ice",
                        "cane-syrup"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "oreo-crumbs"
                    ]
                }
            ]
        },
        "salted-caramel": {
            "name": "Соленый крекер",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/solyoniy-kreker.jpg",
            "allIngredients": {
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "milk": {
                    "name": "Молоко 3,2%",
                    "size500": "140",
                    "size650": "180"
                },
                "assam-tea": {
                    "name": "Чай Ассам заготовка",
                    "size500": "50",
                    "size650": "75"
                },
                "caramel-topping": {
                    "name": "Топпинг Соленая карамель",
                    "size500": "55",
                    "size650": "70"
                },
                "cane-syrup": {
                    "name": "Тростниковый сироп",
                    "size500": "5",
                    "size650": "5"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "size500": "70",
                    "size650": "70"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                },
                "cracker-crumbs": {
                    "name": "Крошка печенья \"соленый крекер\"",
                    "size500": "",
                    "size650": ""
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "milk",
                        "assam-tea",
                        "caramel-topping"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca",
                        "ice",
                        "cane-syrup"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "cracker-crumbs"
                    ]
                }
            ]
        },
        "matcha-coconut": {
            "name": "Зеленая матча кокос",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/zelyonaya-matcha-kokos.jpg",
            "allIngredients": {
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "milk": {
                    "name": "Молоко",
                    "size500": "140",
                    "size650": "180"
                },
                "matcha-prep": {
                    "name": "Матча Заготовка",
                    "size500": "35",
                    "size650": "45"
                },
                "coconut-concentrate": {
                    "name": "Концентрат кокос",
                    "size500": "20",
                    "size650": "25"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "size500": "70",
                    "size650": "70"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                },
                "cane-syrup": {
                    "name": "Тростниковый сироп",
                    "size500": "5",
                    "size650": "5"
                },
                "matcha-powder": {
                    "name": "Матча порошок",
                    "size500": "",
                    "size650": ""
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "milk",
                        "matcha-prep",
                        "coconut-concentrate"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca",
                        "ice",
                        "cane-syrup"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "matcha-powder"
                    ]
                }
            ]
        },
        "berry-mood": {
            "name": "Ягодное настроение",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/yagodnoye-nastroenie.jpg",
            "allIngredients": {
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "assam-tea": {
                    "name": "Чай ассам заготовка",
                    "size500": "50",
                    "size650": "75"
                },
                "milk": {
                    "name": "Молоко 3,2%",
                    "size500": "140",
                    "size650": "180"
                },
                "raspberry-concentrate": {
                    "name": "Концентрат Малина",
                    "size500": "25",
                    "size650": "30"
                },
                "blueberry-concentrate": {
                    "name": "Концентрат Черника",
                    "size500": "25",
                    "size650": "30"
                },
                "cane-syrup": {
                    "name": "Тростниковый сироп",
                    "size500": "5",
                    "size650": "5"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "size500": "70",
                    "size650": "70"
                },
                "berries-garnish": {
                    "name": "Ягоды черники/малины",
                    "size500": "",
                    "size650": ""
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "assam-tea",
                        "milk",
                        "raspberry-concentrate",
                        "blueberry-concentrate"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca",
                        "ice",
                        "cane-syrup"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam",
                        "berries-garnish"
                    ]
                }
            ]
        },
        "banana-ice-cream": {
            "name": "Банановое мороженое",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/banan.jpg",
            "allIngredients": {
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "assam-tea": {
                    "name": "Чай ассам заготовка",
                    "size500": "50",
                    "size650": "75"
                },
                "milk": {
                    "name": "Молоко",
                    "size500": "140",
                    "size650": "180"
                },
                "banana-concentrate": {
                    "name": "Концентрат Банан",
                    "size500": "35",
                    "size650": "40"
                },
                "condensed-milk": {
                    "name": "Сгущеное молоко",
                    "size500": "25",
                    "size650": "30"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                },
                "cheese-foam": {
                    "name": "Сырная пенка",
                    "size500": "70",
                    "size650": "70"
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "assam-tea",
                        "milk",
                        "banana-concentrate",
                        "condensed-milk"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "cheese-foam"
                    ]
                }
            ]
        },
        "snickers": {
            "name": "Сникерс (милкшейк)",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/snickers.jpg",
            "allIngredients": {
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "ice-cream": {
                    "name": "Мороженое 15-20%",
                    "size500": "180",
                    "size650": "230"
                },
                "milk": {
                    "name": "Молоко 3,2%",
                    "size500": "180",
                    "size650": "230"
                },
                "caramel-syrup": {
                    "name": "Сироп/топинг карамель",
                    "size500": "20",
                    "size650": "30"
                },
                "nut-syrup": {
                    "name": "Сироп лесной орех",
                    "size500": "10",
                    "size650": "20"
                },
                "peanuts": {
                    "name": "Жареный Арахис",
                    "size500": "5",
                    "size650": "5"
                }
            },
            "steps": [
                {
                    "description": "В блендере взбить:",
                    "ingredientKeys": [
                        "ice-cream",
                        "milk",
                        "caramel-syrup",
                        "nut-syrup"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca"
                    ]
                },
                {
                    "description": "Перелить содержимое блендера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "peanuts"
                    ]
                }
            ]
        },
        "bounty": {
            "name": "Баунти (милкшейк)",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/bounty.jpg",
            "allIngredients": {
                "tapioca": {
                    "name": "Тапиока",
                    "size500": "80",
                    "size650": "100"
                },
                "ice-cream": {
                    "name": "Мороженое 15-20%",
                    "size500": "190",
                    "size650": "240"
                },
                "milk": {
                    "name": "Молоко 3,2%",
                    "size500": "180",
                    "size650": "230"
                },
                "coconut-concentrate": {
                    "name": "Концентрат Кокос",
                    "size500": "20",
                    "size650": "30"
                },
                "almond-syrup": {
                    "name": "Сироп миндаль",
                    "size500": "10",
                    "size650": "20"
                },
                "coconut-flakes": {
                    "name": "Кокосовая стружка",
                    "size500": "5",
                    "size650": "5"
                }
            },
            "steps": [
                {
                    "description": "В блендере взбить:",
                    "ingredientKeys": [
                        "ice-cream",
                        "milk",
                        "coconut-concentrate",
                        "almond-syrup"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca"
                    ]
                },
                {
                    "description": "Перелить содержимое блендера в стакан.",
                    "ingredientKeys": []
                },
                {
                    "description": "Украсить:",
                    "ingredientKeys": [
                        "coconut-flakes"
                    ]
                }
            ]
        },
        "blueberry-strawberry": {
            "name": "Черника-Клубника (милкшейк)",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/chernika-klubnika.jpg",
            "allIngredients": {
                "tapioca-balls": {
                    "name": "Тапиока/Джусболы",
                    "size500": "80",
                    "size650": "100"
                },
                "ice-cream": {
                    "name": "Мороженое 15-20%",
                    "size500": "150",
                    "size650": "200"
                },
                "milk": {
                    "name": "Молоко 3,2%",
                    "size500": "180",
                    "size650": "230"
                },
                "strawberry-puree": {
                    "name": "Ягода(пюре) Клубника",
                    "size500": "20",
                    "size650": "30"
                },
                "blueberry-puree": {
                    "name": "Ягода(пюре) Черника",
                    "size500": "20",
                    "size650": "30"
                },
                "strawberry-topping": {
                    "name": "Топинг клубника",
                    "size500": "20",
                    "size650": "30"
                }
            },
            "steps": [
                {
                    "description": "В блендере взбить:",
                    "ingredientKeys": [
                        "ice-cream",
                        "milk",
                        "strawberry-puree",
                        "blueberry-puree",
                        "strawberry-topping"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "tapioca-balls"
                    ]
                },
                {
                    "description": "Перелить содержимое блендера в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "lemonade-raspberry-pomegranate": {
            "name": "Лимонад Малина-Гранат",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/limonad-malina-granat.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "sparkling-water": {
                    "name": "Газированная Вода",
                    "size500": "225",
                    "size650": "275"
                },
                "raspberry-concentrate": {
                    "name": "Концентрат Малина",
                    "size500": "40",
                    "size650": "35"
                },
                "berries": {
                    "name": "Ягода малина,гранат",
                    "size500": "10/10",
                    "size650": "15/15"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "150",
                    "size650": "200"
                },
                "grenadine": {
                    "name": "Сироп Гренадин",
                    "size500": "20",
                    "size650": "35"
                }
            },
            "steps": [
                {
                    "description": "В питчере смешать (ложкой):",
                    "ingredientKeys": [
                        "raspberry-concentrate",
                        "grenadine",
                        "berries",
                        "sparkling-water"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "lemonade-mango-passion": {
            "name": "Лимонад Манго-Маракуйя",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/limonad-mango-marakuya.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "sparkling-water": {
                    "name": "Газированная Вода",
                    "size500": "225",
                    "size650": "275"
                },
                "mango-passion-concentrate": {
                    "name": "Концентрат Манго-Маракуйя",
                    "size500": "60",
                    "size650": "80"
                },
                "mango-pieces": {
                    "name": "Манго свежее кусочки",
                    "size500": "20",
                    "size650": "30"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "150",
                    "size650": "200"
                }
            },
            "steps": [
                {
                    "description": "В питчере смешать (ложкой):",
                    "ingredientKeys": [
                        "mango-passion-concentrate",
                        "mango-pieces",
                        "sparkling-water"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "lemonade-pear-kiwi": {
            "name": "Лимонад Груша-Киви",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/limonad-grusha-kivi.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "sparkling-water": {
                    "name": "Газированная Вода",
                    "size500": "225",
                    "size650": "275"
                },
                "pear-concentrate": {
                    "name": "Концентрат Груша",
                    "size500": "40",
                    "size650": "50"
                },
                "kiwi-concentrate": {
                    "name": "Концентрат Киви",
                    "size500": "20",
                    "size650": "25"
                },
                "kiwi-fresh": {
                    "name": "Киви свежий",
                    "size500": "20",
                    "size650": "30"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "150",
                    "size650": "200"
                }
            },
            "steps": [
                {
                    "description": "В питчере смешать (ложкой):",
                    "ingredientKeys": [
                        "pear-concentrate",
                        "kiwi-concentrate",
                        "sparkling-water"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "kiwi-fresh",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "lemonade-pineapple-peach": {
            "name": "Лимонад Ананас-Персик",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/limonad-ananas-persik.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "sparkling-water": {
                    "name": "Газированная Вода",
                    "size500": "225",
                    "size650": "275"
                },
                "pineapple-concentrate": {
                    "name": "Концентрат Ананас",
                    "size500": "40",
                    "size650": "50"
                },
                "peach-concentrate": {
                    "name": "Концентрат Персик",
                    "size500": "20",
                    "size650": "25"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "150",
                    "size650": "200"
                }
            },
            "steps": [
                {
                    "description": "В питчере смешать (ложкой):",
                    "ingredientKeys": [
                        "pineapple-concentrate",
                        "peach-concentrate",
                        "sparkling-water"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "tea-raspberry-pomegranate": {
            "name": "Джус боллы Малина-Гранат",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/balls-malina-granat.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "green-tea": {
                    "name": "Чай зеленый с жасмином",
                    "size500": "100",
                    "size650": "125"
                },
                "water": {
                    "name": "Вода",
                    "size500": "125",
                    "size650": "150"
                },
                "raspberry-concentrate": {
                    "name": "Концентрат Малина",
                    "size500": "40",
                    "size650": "50"
                },
                "berries": {
                    "name": "Ягода малина,гранат",
                    "size500": "10/10",
                    "size650": "15/15"
                },
                "grenadine": {
                    "name": "Сироп Гренадин",
                    "size500": "20",
                    "size650": "25"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "green-tea",
                        "water",
                        "raspberry-concentrate",
                        "grenadine",
                        "berries"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "tea-mango-passion": {
            "name": "Джус боллы Манго-Маракуйя",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/balls-mango-marakuya.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "green-tea": {
                    "name": "Чай зеленый с жасмином",
                    "size500": "120",
                    "size650": "150"
                },
                "water": {
                    "name": "Вода",
                    "size500": "100",
                    "size650": "120"
                },
                "mango-passion-concentrate": {
                    "name": "Концентрат Манго-Маракуйя",
                    "size500": "60",
                    "size650": "80"
                },
                "mango-pieces": {
                    "name": "Манго свежее кусочки",
                    "size500": "20",
                    "size650": "30"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "green-tea",
                        "water",
                        "mango-passion-concentrate",
                        "mango-pieces"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "tea-pear-kiwi": {
            "name": "Джус боллы Груша-Киви",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/balls-grusha-kivi.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "green-tea": {
                    "name": "Чай зеленый с жасмином",
                    "size500": "120",
                    "size650": "150"
                },
                "water": {
                    "name": "Вода",
                    "size500": "100",
                    "size650": "120"
                },
                "pear-concentrate": {
                    "name": "Концентрат Груша",
                    "size500": "40",
                    "size650": "50"
                },
                "kiwi-concentrate": {
                    "name": "Концентрат Киви",
                    "size500": "20",
                    "size650": "25"
                },
                "kiwi-fresh": {
                    "name": "Киви свежий",
                    "size500": "20",
                    "size650": "30"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "green-tea",
                        "water",
                        "pear-concentrate",
                        "kiwi-concentrate"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "kiwi-fresh",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                }
            ]
        },
        "tea-pineapple-peach": {
            "name": "Джус боллы Ананас-Персик",
            "volumeType": "dual",
            "imageUrl": "https://raw.githubusercontent.com/dtorkin/bubble-street/refs/heads/main/photo/balls-ananas-persik.jpg",
            "allIngredients": {
                "juice-balls": {
                    "name": "Джус боллы",
                    "size500": "60",
                    "size650": "80"
                },
                "green-tea": {
                    "name": "Чай зеленый с жасмином",
                    "size500": "120",
                    "size650": "150"
                },
                "water": {
                    "name": "Вода",
                    "size500": "100",
                    "size650": "120"
                },
                "pineapple-concentrate": {
                    "name": "Концентрат Ананас",
                    "size500": "40",
                    "size650": "50"
                },
                "peach-concentrate": {
                    "name": "Концентрат Персик",
                    "size500": "20",
                    "size650": "25"
                },
                "ice": {
                    "name": "Лед",
                    "size500": "120",
                    "size650": "150"
                }
            },
            "steps": [
                {
                    "description": "В шейкере смешать:",
                    "ingredientKeys": [
                        "green-tea",
                        "water",
                        "pineapple-concentrate",
                        "peach-concentrate"
                    ]
                },
                {
                    "description": "В стакан добавить:",
                    "ingredientKeys": [
                        "juice-balls",
                        "ice"
                    ]
                },
                {
                    "description": "Перелить содержимое шейкера в стакан.",
                    "ingredientKeys": []
                }
            ]
        }
    },
    "preparations": {
        "cocoa-prep": {
            "name": "Какао заготовка",
            "description": "В питчере тщательно смешать 10 грамм какао-порошка и 100 мл горячей воды до полного растворения."
        },
        "assam-tea": {
            "name": "Чай Ассам заготовка",
            "description": "25 грамм чая \"Ассам\" заварить в 1 литре воды (95°C) в течение 10 минут, затем процедить."
        },
        "jasmine-green-tea": {
            "name": "Чай зеленый с жасмином заготовка",
            "description": "20 грамм зеленого чая с жасмином заварить в 1 литре воды (80°C) в течение 5-7 минут, затем процедить."
        }
    }
};
    
    // =======================================================================
    // ОСНОВНАЯ ЛОГИКА ПРИЛОЖЕНИЯ (Переписано на ES5 для совместимости)
    // =======================================================================
    var appData = {};
    var activeKey = null;
    var selectedVolume = null;
    var activeTab = 'drinks';
    var sortableInstances = [];
    var adminClickCount = 0;
    var adminClickTimer = null;

    function saveData() { localStorage.setItem('bubbleStreetMenu', JSON.stringify(appData)); }
    function loadData() {
        var saved = localStorage.getItem('bubbleStreetMenu');
        var parsedSaved = saved ? JSON.parse(saved) : null;
        appData = (parsedSaved && parsedSaved.recipes && Object.keys(parsedSaved.recipes).length > 0) ? parsedSaved : JSON.parse(JSON.stringify(initialData));
    }
    
    function renderLists() {
        var drinksList = document.getElementById('drinks-list');
        var prepsList = document.getElementById('preps-list');
        drinksList.innerHTML = '';
        prepsList.innerHTML = '';
        
        Object.keys(appData.recipes).sort(function(a,b) { return appData.recipes[a].name.localeCompare(appData.recipes[b].name) }).forEach(function(key) {
            var link = document.createElement('a');
            link.href = '#';
            link.textContent = appData.recipes[key].name;
            link.dataset.key = key;
            link.dataset.type = 'recipe';
            if (key === activeKey && activeTab === 'drinks') link.classList.add('active');
            var item = document.createElement('li');
            item.appendChild(link);
            drinksList.appendChild(item);
        });

        Object.keys(appData.preparations).sort(function(a,b) { return appData.preparations[a].name.localeCompare(appData.preparations[b].name) }).forEach(function(key) {
            var link = document.createElement('a');
            link.href = '#';
            link.textContent = appData.preparations[key].name;
            link.dataset.key = key;
            link.dataset.type = 'prep';
            if (key === activeKey && activeTab === 'preps') link.classList.add('active');
            var item = document.createElement('li');
            item.appendChild(link);
            prepsList.appendChild(item);
        });
    }
    
    function renderContent(type, key) {
        activeKey = key;
        var output = document.getElementById('content-output');
        if (type === 'recipe') {
            var recipe = appData.recipes[key];
            if (recipe.volumeType === 'single') {
                renderSingleVolumeRecipe(key);
            } else {
                selectedVolume = null;
                var detailsHtml = '<div class="volume-selector">' +
                    '<h1>' + recipe.name + '</h1>' +
                    '<p style="font-size: 1.2em; color: #555;">Выберите объем:</p>' +
                    '<div class="volume-selector-buttons">' +
                        '<button class="volume-btn" onclick="renderRecipeForVolume(\'' + key + '\', \'500\')">500 мл</button>' +
                        '<button class="volume-btn" onclick="renderRecipeForVolume(\'' + key + '\', \'650\')">650 мл</button>' +
                    '</div>' +
                '</div>';
                var imageHtml = recipe.imageUrl ? '<div class="recipe-image-container"><img src="' + recipe.imageUrl + '" alt="' + recipe.name + '"></div>' : '';
                output.innerHTML = '<div class="recipe-view-container"><div class="recipe-details">' + detailsHtml + '</div>' + imageHtml + '</div>';
            }
        } else if (type === 'prep') {
            var prep = appData.preparations[key];
            output.innerHTML = '<div class="recipe-header"><h1>' + prep.name + '</h1>' +
                    '<div class="edit-controls admin-only"><button class="btn" onclick="renderPrepEdit(\'' + key + '\')">Редактировать</button></div>' +
                '</div>' +
                '<div style="font-size: 1.2em; line-height: 1.6;">' + prep.description.replace(/\n/g, '<br>') + '</div>';
        }
        renderLists();
    }

    function renderSingleVolumeRecipe(key) {
        var recipe = appData.recipes[key];
        var output = document.getElementById('content-output');
        
        var stepsHtml = recipe.steps.map(function(step) {
            var ingredientsTableHtml = '';
            if (step.ingredientKeys && step.ingredientKeys.length > 0) {
                var rows = step.ingredientKeys.map(function(ingKey) {
                    var ingData = recipe.allIngredients[ingKey];
                    var amount = ingData ? (ingData.quantity || '') : '';
                    return ingData ? '<tr><td>' + ingData.name + '</td><td>' + amount + '</td></tr>' : '';
                }).join('');
                ingredientsTableHtml = '<table class="step-ingredients-table"><thead><tr><th>Ингредиент</th><th>Количество ('+ recipe.volume +')</th></tr></thead><tbody>' + rows + '</tbody></table>';
            }
            return '<li><div class="step-wrapper"><div class="step-description">' + step.description + '</div>' + ingredientsTableHtml + '</div></li>';
        }).join('');

        var detailsHtml = '<div class="recipe-header"><h1>' + recipe.name + ' (' + recipe.volume + ')</h1><div class="edit-controls admin-only"><button class="btn" onclick="renderRecipeEdit(\'' + key + '\')">Редактировать</button></div></div>' +
            '<ol class="steps-list">' + stepsHtml + '</ol>';
        var imageHtml = recipe.imageUrl ? '<div class="recipe-image-container"><img src="' + recipe.imageUrl + '" alt="' + recipe.name + '"></div>' : '';
        
        output.innerHTML = '<div class="recipe-view-container"><div class="recipe-details">' + detailsHtml + '</div>' + imageHtml + '</div>';
    }

    function renderRecipeForVolume(key, volume) {
        selectedVolume = volume;
        var recipe = appData.recipes[key];
        var output = document.getElementById('content-output');

        var stepsHtml = recipe.steps.map(function(step) {
            var ingredientsTableHtml = '';
            if (step.ingredientKeys && step.ingredientKeys.length > 0) {
                var rows = step.ingredientKeys.map(function(ingKey) {
                    var ingData = recipe.allIngredients[ingKey];
                    var amount = ingData ? (ingData['size' + volume] || '') : '';
                    return ingData ? '<tr><td>' + ingData.name + '</td><td>' + amount + '</td></tr>' : '';
                }).join('');
                ingredientsTableHtml = '<table class="step-ingredients-table"><thead><tr><th>Ингредиент</th><th>Кол-во (' + volume + 'мл)</th></tr></thead><tbody>' + rows + '</tbody></table>';
            }
            return '<li><div class="step-wrapper"><div class="step-description">' + step.description + '</div>' + ingredientsTableHtml + '</div></li>';
        }).join('');

        var detailsHtml = '<div class="recipe-header"><h1>' + recipe.name + '</h1><div class="edit-controls admin-only"><button class="btn" onclick="renderRecipeEdit(\'' + key + '\')">Редактировать</button></div></div>' +
            '<div class="volume-toggle">' +
                '<button class="toggle-btn ' + (volume === '500' ? 'active' : '') + '" onclick="renderRecipeForVolume(\'' + key + '\', \'500\')">500 мл</button>' +
                '<button class="toggle-btn ' + (volume === '650' ? 'active' : '') + '" onclick="renderRecipeForVolume(\'' + key + '\', \'650\')">650 мл</button>' +
            '</div>' +
            '<ol class="steps-list">' + stepsHtml + '</ol>';
        var imageHtml = recipe.imageUrl ? '<div class="recipe-image-container"><img src="' + recipe.imageUrl + '" alt="' + recipe.name + '"></div>' : '';
        
        output.innerHTML = '<div class="recipe-view-container"><div class="recipe-details">' + detailsHtml + '</div>' + imageHtml + '</div>';
    }
    
    function renderRecipeEdit(key) {
        destroySortables();
        var recipe = appData.recipes[key];
        var output = document.getElementById('content-output');
        var stepsHtml = recipe.steps.map(function(step, stepIndex) {
            return renderEditStep(key, step, stepIndex);
        }).join('');
        output.innerHTML = '<div class="edit-form">' +
            '<h2>Редактирование "' + recipe.name + '"</h2>' +
            '<label>Название напитка:</label><input type="text" id="edit-recipe-name" value="' + recipe.name + '">' +
            '<label>Ссылка на изображение (с GitHub):</label><input type="text" id="edit-image-url" value="' + (recipe.imageUrl || '') + '">' +
            (recipe.volumeType === 'single' ? '<label>Объем (например, 500 мл):</label><input type="text" id="edit-recipe-volume" value="' + (recipe.volume || '') + '">' : '') +
            '<div id="edit-steps-container">' + stepsHtml + '</div>' +
            '<button onclick="addStep(\'' + key + '\')">+ Добавить шаг</button><hr style="margin: 20px 0;">' +
            '<div class="edit-controls">' +
                 '<button class="btn-primary" onclick="saveRecipeEdit(\'' + key + '\')">Сохранить</button>' +
                 '<button class="btn" onclick="renderContent(\'recipe\', \'' + key + '\')">Отмена</button>' +
                 '<button class="btn-danger" style="float: right;" onclick="deleteItem(\'recipe\', \'' + key + '\')">Удалить</button>' +
            '</div>' +
        '</div>';
        initSortables(key);
    }
    
    function renderPrepEdit(key) {
        var prep = appData.preparations[key];
        var output = document.getElementById('content-output');
        output.innerHTML = '<div class="edit-form">' +
            '<h2>Редактирование "' + prep.name + '"</h2>' +
            '<label>Название заготовки:</label><input type="text" id="edit-prep-name" value="' + prep.name + '">' +
            '<label>Описание / Рецепт:</label><textarea id="edit-prep-desc" rows="6">' + prep.description + '</textarea>' +
            '<hr style="margin: 20px 0;">' +
            '<div class="edit-controls">' +
                 '<button class="btn-primary" onclick="savePrepEdit(\'' + key + '\')">Сохранить</button>' +
                 '<button class="btn" onclick="renderContent(\'prep\', \'' + key + '\')">Отмена</button>' +
                 '<button class="btn-danger" style="float: right;" onclick="deleteItem(\'prep\', \'' + key + '\')">Удалить</button>' +
            '</div>' +
        '</div>';
    }
    
    function renderEditStep(key, step, stepIndex) {
        var recipe = appData.recipes[key];
        var isSingle = recipe.volumeType === 'single';

        var ingredientsHtml = step.ingredientKeys.map(function(ingKey) {
             var ingData = recipe.allIngredients[ingKey];
             if(!ingData) return '';
             if(isSingle) {
                return '<div class="edit-ingredient edit-ingredient-single" data-ing-key="' + ingKey + '">' +
                    '<input type="text" value="' + ingData.name + '" placeholder="Название">' +
                    '<input type="text" value="' + ingData.quantity + '" placeholder="Кол-во">' +
                    '<button onclick="removeIngredientFromStep(this)">&times;</button>' +
                '</div>';
             } else {
                return '<div class="edit-ingredient" data-ing-key="' + ingKey + '">' +
                    '<input type="text" value="' + ingData.name + '" placeholder="Название">' +
                    '<input type="text" value="' + ingData.size500 + '" placeholder="500мл">' +
                    '<input type="text" value="' + ingData.size650 + '" placeholder="650мл">' +
                    '<button onclick="removeIngredientFromStep(this)">&times;</button>' +
                '</div>';
             }
        }).join('');

        var headerHtml = isSingle 
            ? '<div class="edit-ingredient-header edit-ingredient-header-single"><span>Ингредиент</span><span>Количество</span></div>'
            : '<div class="edit-ingredient-header"><span>Ингредиент</span><span>500мл</span><span>650мл</span></div>';

        return '<div class="edit-step" data-step-index="' + stepIndex + '">' +
            '<h4>Шаг ' + (stepIndex + 1) + '</h4>' +
            '<textarea rows="2" placeholder="Описание шага">' + step.description + '</textarea>' +
            headerHtml +
            '<div class="edit-ingredient-container">' + ingredientsHtml + '</div>' +
            '<button onclick="addIngredientToStep(this, \''+ recipe.volumeType +'\')">+ Ингредиент</button>' +
            '<button class="btn-danger" onclick="removeStep(this)">Удалить шаг</button>' +
        '</div>';
    }

    function saveRecipeEdit(key) {
        var newName = document.getElementById('edit-recipe-name').value.trim();
        if (!newName) { alert('Название напитка не может быть пустым.'); return; }
        
        var recipe = appData.recipes[key];
        var isSingle = recipe.volumeType === 'single';

        var editedRecipe = { 
            name: newName, 
            volumeType: recipe.volumeType,
            imageUrl: document.getElementById('edit-image-url').value.trim(), 
            allIngredients: {}, 
            steps: [] 
        };
        
        if (isSingle) {
            editedRecipe.volume = document.getElementById('edit-recipe-volume').value;
        }
        
        document.querySelectorAll('#edit-steps-container .edit-step').forEach(function(stepEl) {
            var description = stepEl.querySelector('textarea').value;
            var newStep = { description: description, ingredientKeys: [] };
            stepEl.querySelectorAll('.edit-ingredient, .edit-ingredient-single').forEach(function(ingEl) {
                var ingKey = ingEl.dataset.ingKey;
                var inputs = ingEl.querySelectorAll('input');
                var ingName = inputs[0].value.trim();
                if (!ingName) return;
                
                if (isSingle) {
                    editedRecipe.allIngredients[ingKey] = { name: ingName, quantity: inputs[1].value };
                } else {
                    editedRecipe.allIngredients[ingKey] = { name: ingName, size500: inputs[1].value, size650: inputs[2].value };
                }
                newStep.ingredientKeys.push(ingKey);
            });
            editedRecipe.steps.push(newStep);
        });

        appData.recipes[key] = editedRecipe;
        saveData();

        if (isSingle) {
            renderSingleVolumeRecipe(key);
        } else {
            renderRecipeForVolume(key, selectedVolume || '500');
        }
    }

    function savePrepEdit(key) {
        var newName = document.getElementById('edit-prep-name').value.trim();
        if (!newName) { alert('Название заготовки не может быть пустым.'); return; }
        appData.preparations[key] = { name: newName, description: document.getElementById('edit-prep-desc').value };
        saveData();
        renderContent('prep', key);
    }
    
    function deleteItem(type, key) {
        var collection = type === 'recipe' ? appData.recipes : appData.preparations;
        var name = collection[key].name;
        if (confirm('Вы уверены, что хотите удалить "' + name + '"?')) {
            delete collection[key];
            saveData();
            activeKey = null;
            document.getElementById('content-output').innerHTML = '<div class="content-placeholder"><p>Элемент удален.</p></div>';
            renderLists();
        }
    }
    
    function addStep(key) {
        appData.recipes[key].steps.push({ description: 'Новый шаг', ingredientKeys: [] });
        renderRecipeEdit(key);
    }
    function removeStep(element) { element.closest('.edit-step').remove(); }
    function addIngredientToStep(element, volumeType) {
        var container = element.previousElementSibling;
        var newIngKey = 'ing_' + Date.now();
        var newIngDiv = document.createElement('div');
        
        if (volumeType === 'single') {
            newIngDiv.className = 'edit-ingredient edit-ingredient-single';
            newIngDiv.innerHTML = '<input type="text" placeholder="Название"><input type="text" placeholder="Кол-во"><button onclick="removeIngredientFromStep(this)">&times;</button>';
        } else {
            newIngDiv.className = 'edit-ingredient';
            newIngDiv.innerHTML = '<input type="text" placeholder="Название"><input type="text" placeholder="500мл"><input type="text" placeholder="650мл"><button onclick="removeIngredientFromStep(this)">&times;</button>';
        }
        newIngDiv.dataset.ingKey = newIngKey;
        container.appendChild(newIngDiv);
    }
    function removeIngredientFromStep(element) { element.closest('.edit-ingredient, .edit-ingredient-single').remove(); }
    
    function initSortables() {
        destroySortables();
        var stepsContainer = document.getElementById('edit-steps-container');
        if (stepsContainer) {
            sortableInstances.push(new Sortable(stepsContainer, { animation: 150, handle: 'h4', ghostClass: 'sortable-ghost' }));
        }
        document.querySelectorAll('.edit-ingredient-container').forEach(function(container) {
            sortableInstances.push(new Sortable(container, { animation: 150, ghostClass: 'sortable-ghost' }));
        });
    }
    function destroySortables() {
        sortableInstances.forEach(function(s) { s.destroy(); });
        sortableInstances = [];
    }

    function showExportModal() {
        var dataString = 'var initialData = ' + JSON.stringify(appData, null, 4) + ';';
        document.getElementById('export-textarea').value = dataString;
        document.getElementById('export-modal').style.display = 'flex';
    }

    function closeExportModal() {
        document.getElementById('export-modal').style.display = 'none';
    }
    
    function enableAdminMode() {
        document.body.classList.add('admin-mode-active');
        sessionStorage.setItem('adminMode', 'true');
        alert('Режим администратора активирован!');
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (sessionStorage.getItem('adminMode') === 'true') {
            document.body.classList.add('admin-mode-active');
        }
        
        loadData();
        renderLists();
        
        document.getElementById('menu-title-trigger').addEventListener('click', function() {
            clearTimeout(adminClickTimer);
            adminClickCount++;
            if (adminClickCount === 5) {
                enableAdminMode();
                adminClickCount = 0;
            }
            adminClickTimer = setTimeout(function() { adminClickCount = 0; }, 1500);
        });
        
        document.querySelector('.sidebar-tabs').addEventListener('click', function(e) {
            if (e.target.tagName !== 'BUTTON') return;
            var newTab = e.target.id === 'tab-drinks' ? 'drinks' : 'preps';
            if (newTab === activeTab) return;
            activeTab = newTab;
            
            document.getElementById('tab-drinks').classList.toggle('active', activeTab === 'drinks');
            document.getElementById('drinks-list').style.display = activeTab === 'drinks' ? '' : 'none';
            document.getElementById('tab-preps').classList.toggle('active', activeTab === 'preps');
            document.getElementById('preps-list').style.display = activeTab === 'preps' ? '' : 'none';
            document.getElementById('new-item-btn').textContent = activeTab === 'drinks' ? 'Создать новый напиток' : 'Создать заготовку';
            
            activeKey = null;
            document.getElementById('content-output').innerHTML = '<div class="content-placeholder"><p>← Выберите элемент из меню</p></div>';
            renderLists();
        });
        
        document.querySelector('.sidebar-content').addEventListener('click', function(e) {
            var link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                renderContent(link.dataset.type, link.dataset.key);
            }
        });
        
        document.getElementById('new-item-btn').addEventListener('click', function() {
            var key = (activeTab === 'drinks' ? 'recipe_' : 'prep_') + Date.now();
            if (activeTab === 'drinks') {
                var newRecipeType = prompt('Введите тип напитка: "dual" для двух объемов или "single" для одного.', 'dual');
                if (newRecipeType !== 'dual' && newRecipeType !== 'single') {
                    alert('Неверный тип. Попробуйте еще раз.');
                    return;
                }
                appData.recipes[key] = { name: 'Новый напиток', volumeType: newRecipeType, imageUrl: '', allIngredients: {}, steps: [{ description: 'Первый шаг', ingredientKeys: [] }] };
                if (newRecipeType === 'single') {
                    appData.recipes[key].volume = '500 мл';
                }
                renderRecipeEdit(key);
            } else {
                appData.preparations[key] = { name: 'Новая заготовка', description: '' };
                renderPrepEdit(key);
            }
            activeKey = key;
            renderLists();
        });

        document.getElementById('export-btn').addEventListener('click', showExportModal);
        document.getElementById('export-modal-close').addEventListener('click', closeExportModal);
        document.getElementById('export-modal').addEventListener('click', function(e) {
            if (e.target === e.currentTarget) closeExportModal();
        });
        document.getElementById('copy-code-btn').addEventListener('click', function() {
            var textarea = document.getElementById('export-textarea');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'Код скопирован в буфер обмена!' : 'Не удалось скопировать код.';
                alert(msg);
            } catch (err) {
                alert('Не удалось скопировать код. Пожалуйста, сделайте это вручную.');
            }
        });
    });
    </script>
</body>
</html>
